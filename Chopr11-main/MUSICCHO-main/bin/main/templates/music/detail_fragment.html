<div style="margin-top: 50px; border-top: 2px solid #f5f5f7; padding-top: 30px;">
    <h3 style="font-weight: 700; margin-bottom: 20px;">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ (<span th:text="${#lists.size(music.answerList)}"></span>)</h3>
    
    <div sec:authorize="isAuthenticated()" style="margin-bottom: 30px;">
        <textarea id="commentInput" style="width: 100%; height: 100px; padding: 15px; border-radius: 12px; border: 1px solid #ddd; resize: none; margin-bottom: 10px;" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã—ã¦ãã ã•ã„ã€‚"></textarea>
        <button th:onclick="|submitComment(${music.id})|" style="float: right; background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 10px; cursor: pointer; font-weight: 600;">æŠ•ç¨¿</button>
        <div style="clear: both;"></div>
    </div>

    <div sec:authorize="isAnonymous()" style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px; text-align: center;">
        <p style="color: #86868B;">ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯<a href="/user/login" style="color: var(--primary); text-decoration: none; font-weight: 600;">ãƒ­ã‚°ã‚¤ãƒ³</a>ãŒå¿…è¦ã§ã™ã€‚</p>
    </div>
    
    <div id="commentList">
        <div th:each="answer : ${music.answerList}" style="padding: 20px; border-bottom: 1px solid #eee;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <strong th:text="${answer.author != null ? answer.author.username : 'åŒ¿å'}" style="color: #1D1D1F;"></strong>
                <span th:text="${#temporals.format(answer.createDate, 'yyyy-MM-dd HH:mm')}" style="color: #86868B; font-size: 13px;"></span>
            </div>
            <p th:text="${answer.content}" style="color: #424245; line-height: 1.5;"></p>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // [ëŒ“ê¸€ ë“±ë¡ í•¨ìˆ˜]
    async function submitComment(id) {
        const content = document.getElementById('commentInput').value;
        if(!content.trim()) {
            alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        // CSRFå¯¾ç­–: metaã‚¿ã‚°ã‹ã‚‰å–å¾—
        const token = document.querySelector('meta[name="_csrf"]')?.content;
        const header = document.querySelector('meta[name="_csrf_header"]')?.content;

        if (!token || !header) {
            console.error("CSRF token not found");
            return;
        }

        const formData = new URLSearchParams();
        formData.append('content', content);

        try {
            const res = await fetch('/answer/create/' + id, {
                method: 'POST',
                headers: { 
                    [header]: token,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            });

            if (res.ok) {
                // æˆåŠŸæ™‚ã¯ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤º
                location.reload();
            } else if (res.status === 403) {
                alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
                location.href = '/user/login';
            } else {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            }
        } catch (e) {
            console.error("Fetch Error:", e);
        }
    }

    // [ã„ã„ã­é–¢æ•°]
    async function likeMusic(id) {
        const token = document.querySelector('meta[name="_csrf"]')?.content;
        const header = document.querySelector('meta[name="_csrf_header"]')?.content;

        try {
            const res = await fetch('/music/like/' + id, {
                method: 'POST',
                headers: { [header]: token }
            });
            if (res.ok) {
                const data = await res.json();
                document.getElementById('likeCount').innerText = data.likes;
            } else if (res.status === 403) {
                alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
                location.href = '/user/login';
            }
        } catch (e) {
            console.error("Error:", e);
        }
    }
</script>