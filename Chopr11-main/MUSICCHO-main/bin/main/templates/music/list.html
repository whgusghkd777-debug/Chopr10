<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{fragments/head :: head}"></th:block>
<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container">
        <section class="ranking-section">
            <div class="ranking-header">üî• ‰∫∫Ê∞ó„É©„É≥„Ç≠„É≥„Ç∞</div>
            <div class="ranking-list" id="rankingList"></div>
        </section>

        <div class="music-grid" id="musicGrid"></div>
    </div>

    <button class="fab" onclick="handleFabClick()">+</button>

    <div th:replace="~{fragments/modal :: modals}"></div>

    <script th:inline="javascript">
        let musicData = [];
        let adminMode = false;
        let selectedId = null;
        let shareType = 'youtube';
        let currentLikes = 0;
        let isLiked = false;
        let isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;

        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content || /*[[${_csrf.token}]]*/ '';
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || /*[[${_csrf.headerName}]]*/ '';

        const sampleData = [
            {
                id: 1,
                title: "„Çµ„É≥„Éó„É´Êõ≤1",
                artist: "„Çµ„É≥„Éó„É´„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà",
                url: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
                likes: 42,
                category: "POP",
                content: "„Åì„Çå„ÅØ„Çµ„É≥„Éó„É´Ë™¨Êòé„Åß„Åô„ÄÇ"
            },
            {
                id: 2,
                title: "„Çµ„É≥„Éó„É´Êõ≤2",
                artist: "„ÉÜ„Çπ„Éà„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà",
                url: "https://www.youtube.com/watch?v=example2",
                likes: 15,
                category: "ROCK",
                content: "„ÇÇ„ÅÜ‰∏Ä„Å§„ÅÆ„Çµ„É≥„Éó„É´„ÄÇ"
            }
        ];

        window.onload = () => {
            loadList();
        };

        async function loadList() {
            try {
                const res = await fetch('/music/listJson');
                if (res.ok) {
                    musicData = await res.json();
                } else {
                    musicData = sampleData;
                }
            } catch (e) {
                musicData = sampleData;
            }
            renderRanking(musicData);
            renderGrid(musicData);
        }

        function renderRanking(data) {
            const rankingList = document.getElementById('rankingList');
            if (data.length === 0) {
                rankingList.innerHTML = '<p class="empty-state">„Åæ„Å†Èü≥Ê•Ω„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
                return;
            }

            const top5 = data.slice(0, 5);
            rankingList.innerHTML = top5.map((m, index) => `
                <div class="ranking-item" onclick="openDetail(${m.id})">
                    <div class="rank-badge rank-${index + 1 <= 3 ? index + 1 : 'other'}">${index + 1}</div>
                    <div class="rank-thumb">
                        <img src="https://img.youtube.com/vi/${extractVideoId(m.url)}/mqdefault.jpg" alt="${m.title}">
                    </div>
                    <div class="rank-info">
                        <div class="rank-title">${escapeHtml(m.title)}</div>
                        <div class="rank-artist">${escapeHtml(m.artist)}</div>
                    </div>
                    <div class="rank-likes">${m.likes} ‚ù§Ô∏è</div>
                </div>
            `).join('');
        }

        function renderGrid(data) {
            const musicGrid = document.getElementById('musicGrid');
            if (data.length === 0) {
                musicGrid.innerHTML = '<p class="empty-state">„Åæ„Å†Èü≥Ê•Ω„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
                return;
            }

            musicGrid.innerHTML = data.map(m => `
                <div class="music-card ${adminMode ? 'delete-mode' : ''}" onclick="${adminMode ? `deleteMusic(${m.id})` : `openDetail(${m.id})`}">
                    <div class="card-thumb">
                        <img src="https://img.youtube.com/vi/${extractVideoId(m.url)}/hqdefault.jpg" alt="${m.title}">
                    </div>
                    <div class="card-body">
                        <h3>${escapeHtml(m.title)}</h3>
                        <p>${escapeHtml(m.artist)}</p>
                        <div class="card-stats">
                            <div class="card-stat">‚ù§Ô∏è ${m.likes}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function openDetail(id) {
            selectedId = id;
            try {
                const res = await fetch(`/music/detail/${id}`);
                if (res.ok) {
                    const m = await res.json();
                    document.getElementById('detailTitle').textContent = m.title;
                    document.getElementById('detailArtist').textContent = m.artist;
                    document.getElementById('detailLikeCount').textContent = m.likes;
                    currentLikes = m.likes;
                    isLiked = m.likers?.some(u => u.username === /*[[${#authentication?.name}]]*/ '') || false;

                    const videoContainer = document.getElementById('videoContainer');
                    if (m.url.includes('youtube.com') || m.url.includes('youtu.be')) {
                        const videoId = extractVideoId(m.url);
                        videoContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
                    } else {
                        videoContainer.innerHTML = `<audio controls><source src="${m.url}" type="audio/mpeg">„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØaudio„Çø„Ç∞„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</audio>`;
                    }

                    const commentList = document.getElementById('commentList');
                    if (m.answerList && m.answerList.length > 0) {
                        commentList.innerHTML = m.answerList.map(ans => `
                            <div class="comment-item">
                                <strong>${escapeHtml(ans.author.username)}</strong>
                                <div>${escapeHtml(ans.content)}</div>
                            </div>
                        `).join('');
                    } else {
                        commentList.innerHTML = '<p class="empty-state">„Åæ„Å†„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
                    }
                    updateLikeButton();
                } else {
                    alert('„É≠„Éº„ÉâÂ§±Êïó');
                    return;
                }
            } catch (e) {
                alert('„Ç®„É©„Éº: ' + e.message);
                return;
            }
            openModal('detail');
        }

        function updateLikeButton() {
            const likeBtn = document.getElementById('likeBtn');
            const likeIcon = document.getElementById('likeIcon');
            const likeText = document.getElementById('likeText');
            const likeCountEl = document.getElementById('likeCount');

            if (isLiked) {
                likeBtn.classList.add('liked');
                likeIcon.textContent = '‚ù§Ô∏è';
                likeText.textContent = '„ÅÑ„ÅÑ„Å≠Ê∏à„Åø';
            } else {
                likeBtn.classList.remove('liked');
                likeIcon.textContent = 'ü§ç';
                likeText.textContent = '„ÅÑ„ÅÑ„Å≠';
            }
            likeCountEl.textContent = currentLikes;
        }

        async function toggleLike() {
            if (!isAuthenticated) {
                alert('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                closeModal('detail');
                openModal('login');
                return;
            }

            try {
                const res = await fetch(`/music/like/${selectedId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                });

                if (res.ok) {
                    const data = await res.json();
                    currentLikes = data.likes;
                    isLiked = data.isLiked;
                    updateLikeButton();
                    loadList();
                } else {
                    alert('„ÅÑ„ÅÑ„Å≠„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (e) {
                alert('„Ç®„É©„Éº: ' + e.message);
            }
        }

        function openModal(type) {
            const modal = document.getElementById(type + 'Modal');
            if (modal) modal.classList.add('active');
        }

        function closeModal(type) {
            const modal = document.getElementById(type + 'Modal');
            if (modal) modal.classList.remove('active');
        }

        function handleFabClick() {
            if (!isAuthenticated) {
                openModal('login');
            } else {
                openModal('share');
                setShareType('youtube');
            }
        }

        function setShareType(type) {
            shareType = type;
            document.getElementById('btnYoutube').classList.toggle('active', type === 'youtube');
            document.getElementById('btnFile').classList.toggle('active', type === 'file');
            document.getElementById('youtubeSection').style.display = type === 'youtube' ? 'block' : 'none';
            document.getElementById('fileSection').style.display = type === 'file' ? 'block' : 'none';
        }

        async function shareMusic() {
            const formData = new FormData();
            formData.append('title', document.getElementById('inTitle').value);
            formData.append('artist', document.getElementById('inArtist').value);
            formData.append('description', document.getElementById('inDesc').value || '');

            if (shareType === 'youtube') {
                formData.append('url', document.getElementById('inUrl').value);
            } else if (shareType === 'file') {
                const fileInput = document.getElementById('audioFile');
                if (fileInput.files[0]) {
                    formData.append('audioFile', fileInput.files[0]);
                }
            }

            formData.append('category', 'POP');

            try {
                const res = await fetch('/music/create', {
                    method: 'POST',
                    headers: { [csrfHeader]: csrfToken },
                    body: formData
                });

                if (res.ok) {
                    alert('Èü≥Ê•Ω„ÅåÊ≠£Â∏∏„Å´ÂÖ±Êúâ„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                    document.getElementById('inTitle').value = '';
                    document.getElementById('inArtist').value = '';
                    document.getElementById('inDesc').value = '';
                    document.getElementById('inUrl').value = '';
                    closeModal('share');
                    loadList();
                } else {
                    alert('ÂÖ±ÊúâÂ§±Êïó');
                }
            } catch (e) {
                alert('„Ç®„É©„Éº: ' + e.message);
            }
        }

        function extractVideoId(url) {
            if (!url) return 'dQw4w9WgXcQ';
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : 'dQw4w9WgXcQ';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>